
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@using AlphaTechMIS.Resources
@Scripts.Render("~/Content/jqxGrid/js")
<script>
    var rowCounts = 0;
    var DealerCurrencyID = 1;
    $(document).ready(function () {
        makeDates(["D_EDate"], "FrmSale", "rtl");
        
        setDetailgrid();
        FillSelect2('/INV/z_Product/ProductList', 'ProductID', 'ProductID', 'PName', '@Resource.Please_Select');
        FillSelect2('/INV/Purchase/GetDealer?TypeID=1', 'DealerID', 'DealerID', 'Name', '@Resource.Please_Select');

        $('#tblProductList').delegate('a.removeCash', 'click', function () {

            $(this).parent().parent().parent().parent().parent().remove();
            var TP = 0;
            $('tr.dataCash').each(function () {
                TP += Number($(this).find('.TotalPrice').text());
            });
            $("#TotalPrice").val(TP);
            rowCounts -= 1;
        });
        for (var i = 1; i < 3; i++)
            setgrid(i);

        $("#AddRow").click(function () {
            var Product = $('#ProductID :selected').text();
            var Unit = $("#UnitID :selected").text();
            var Discount_Type = $("#Discount_Type :selected").text();


            var ProductID = $("#ProductID").val();
            var UnitID = $("#UnitID").val();
            var Discount_Type = $("#Discount_Type").val();

            var Quantity = $("#Quantity").val();
            var UnitPrice = $("#UnitPrice").val();
            var DiscountQuantity = $("#DiscountQuantity").val();

            var TotalPrice = Quantity * UnitPrice;
            var TP = 0;
            var check_if_exist = $(".Product" + ProductID).val();

            if (check_if_exist != undefined && check_if_exist == ProductID) {
                toastr["error"]('this product already added to the list');
                return;
            }
            if (ProductID != 0 && UnitID != 0 && Quantity != "" && UnitPrice != "") {

                var tr =

                    `<tr class="dataCash" id="datarow` + rowCounts + `">
                         <td>`+ Product + `<input type="hidden" class="Products Product` + ProductID + `" value="` + ProductID + `" />   </td>
                         <td>`+ Quantity + `<input type="hidden" class="Quantities" value="` + Quantity + `" /> </td>
                         <td>`+ Unit + `<input type="hidden" class="Units" value="` + UnitID + `" /></td>
                         <td>`+ UnitPrice + `<input type="hidden" class="UnitPrices" value="` + UnitPrice + `" /> </td>
                         <td>`+ Discount_Type + `<input type="hidden" class="Discount_Types" value="` + Discount_Type + `" /> </td>
                         <td>`+ DiscountQuantity + `<input type="hidden" class="DiscountQuantitys" value="` + DiscountQuantity + `" /> </td>
                         <td class="TotalPrice">`+ TotalPrice + `</td>
                         <td>
                             <div class="dropdown font-sans-serif position-static">
                                 <button class="btn btn-link text-600 btn-sm dropdown-toggle btn-reveal" type="button" data-bs-toggle="dropdown" data-boundary="window" aria-haspopup="true" aria-expanded="false"><span class="fas fa-ellipsis-h fs--1"></span></button>
                                 <div class="dropdown-menu dropdown-menu-end border py-0">
                                     <div class="bg-white py-2"><a class="dropdown-item" href="#!">@Resource.Edit</a><a class="dropdown-item text-danger removeCash" href="#!">@Resource.Delete</a></div>
                                 </div>
                             </div>
                         </td>
                    </tr>`;


                $('#tblProductList').append(tr);

            } else {
                toastr["error"]("Please fill the required fields ");
                $("#AddRow").attr("disable", true);
                return;
            }
            $('tr.dataCash').each(function () {

                TP += Number($(this).find('.TotalPrice').text());

            });
            $("#TotalPrice").val(TP);


        });
        $("#Save").click(function () {
            DueBalance();
            var validationResult = function (isValid) {
                if (isValid) {

                    var varURL = ($("#SaleID").val() == '' || $("#SaleID").val() == null) ? '/INV/Sale/Create' : '/INV/Sale/Update';
                    if ($('tr.dataCash').length < 1) {
                        toastr["error"]('@Resource.PleaseAddAtleastOneTransaction');

                    }

                    else {
                        Tra_data = [];
                        $('tr.dataCash').each(function () {
                            data = { "Products": "", "Quantities": "", "UnitPrices": "", "Units": "", "Discount_Types": "","DiscountQuantitys":"" }

                            data.Products = $(this).find('.Products').val();
                            data.Quantities = $(this).find('.Quantities').val();
                            data.UnitPrices = $(this).find('.UnitPrices').val();
                            data.Units = $(this).find('.Units').val();
                            data.Discount_Types = $(this).find('.Discount_Types').val();
                            data.DiscountQuantitys = $(this).find('.DiscountQuantitys').val();

                            Tra_data.push(data);

                        });
                        $("#Tran_data").val(JSON.stringify(Tra_data));


                        if ($("#SaleID").val() == '') {
                            $("#SaleID").remove();
                        }
                        $.ajax(
                            {
                                url: varURL,
                                type: 'post',
                                data: $('#FrmSale').serialize(),
                                success: function (result) {

                                    if (result == "true") {
                                        toastr["success"]('@Resource.Record_Saved')
                                        $('#FrmSale').append("<input type='hidden' id='SaleID' name='SaleID' />");
                                        //$('#ModelSale').modal('hide');
                                        $('#SaleID').val('');
                                        $('#GrdWholesale').jqxGrid('updatebounddata', 'data');
                                        $('#GrdRetail').jqxGrid('updatebounddata', 'data');

                                        
                                    }
                                    else if (result == "update") {
                                        toastr["success"]('@Resource.Record_Update')
                                        $('#FrmSale').append("<input type='hidden' id='SaleID' name='SaleID' />");
                                        $('#SaleID').val('');
                                        $('#ModelSale').modal('hide');
                                        $('#GrdWholesale').jqxGrid('updatebounddata', 'data');
                                        $('#GrdRetail').jqxGrid('updatebounddata', 'data');
                                    }

                                    else {
                                        toastr["error"](result);

                                    }
                                }
                            });
                    }
                }

            }

            $('#FrmSale').jqxValidator('validate', validationResult);
        });
        $('#FrmSale').jqxValidator({
            hintType: 'label',
            animationDuration: 0,
            rtl: true,
            rules: [

                { input: '#D_EDate', message: '@Resource.Required', action: 'change, blur', rule: 'required' },
                { input: '#PaidAmount', message: '@Resource.Required', action: 'change, blur', rule: 'required' },

            ], theme: 'classic'
        });


        $("#MenuW").on('itemclick', function (event) {
            var args = event.args;
            var rowindex = $("#GrdWholesale").jqxGrid('getselectedrowindex');
            if ($.trim($(args).text()) == "Detail") {
                editrow = rowindex;
                var offset = $("#GrdWholesale").offset();
                var dataRecord = $("#GrdWholesale").jqxGrid('getrowdata', editrow);
                fillDetailgrid('/INV/Sale/GetSaleDetail?SaleID=' + dataRecord.SaleID);
                $("#ModelSaleDetail").modal('show');
            }

            else {

            }
        });
        $("#MenuR").on('itemclick', function (event) {
            var args = event.args;
            var rowindex = $("#GrdRetail").jqxGrid('getselectedrowindex');
            if ($.trim($(args).text()) == "Detail") {
                editrow = rowindex;
                var offset = $("#GrdRetail").offset();
                var dataRecord = $("#GrdRetail").jqxGrid('getrowdata', editrow);
                fillDetailgrid('/INV/Sale/GetSaleDetail?SaleID=' + dataRecord.SaleID);
                $("#ModelSaleDetail").modal('show');
            }

            else {

            }
        });

    });
</script>
<div class="card card-primary mb-3">
    <div class="card-header">
        <div class="row flex-between-center">
            <div class="col-8 col-sm-auto text-end ps-2">
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab1" onclick="MakeTabActive(1)">Wholesale</a></li>
                    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab2" onclick="MakeTabActive(2)">Retail</a></li>
                </ul>
            </div>

            <div class="col-4 col-sm-auto text-end ps-2">
                <div id="table-customers-replace-element">
                    <button class="btn btn-outline-primary btn-sm" id="BtnAdd" type="button" data-bs-toggle="modal" data-bs-target="#ModelSale">
                        <span class="d-none d-sm-inline-block ms-1">@Resource.New </span>
                        <span class="fas fa-plus" data-fa-transform="shrink-3 down-2"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="card-body p-2 bg-light">

        <div class="border-bottom p-3">
            <div class="tab-pane show active" id="tab1">
                <div id="GrdWholesale">
                </div>
            </div>
            <div class="tab-pane d-none" id="tab2">
                <div id="GrdRetail">

                </div>
            </div>
        </div>
    </div>
</div>
<div id="ModelSale" class="modal fade" data-keyboard="false" data-bs-backdrop="static">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">@Resource.Sale</h5>
                <button type="button" class="btn-close btn btn-sm btn-circle transition-base p-0" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="FrmSale">
                    <div class="row p-2">
                        <div class="col-md-4">
                            <fieldset>
                                <legend>@Resource.TransactionInfo</legend>
                                <div class="row p-2">
                                    <div class="col-md-12">
                                        <label for="DealerID"> @Resource.Customer</label><br />
                                        <select id="DealerID" name="DealerID" class="select_2 form-control form-control-sm" onchange="fillExchangeRate();">
                                        </select>
                                    </div>

                                </div>
                                <div class="row p-2">
                                    <div class="col-md-6">
                                        <label for="D_EDate"> @Resource.Hijri_Shamsi_Date</label><br />
                                        <input type="text" name="D_EDate" id="D_EDate" autocomplete="off" dir="auto" class="form-control form-control-sm" />
                                    </div>
                                    <div class="col-md-6">
                                        <label for="ExRate"> @Resource.ExchangeRate</label><br />
                                        <input type="text" name="ExchangeRate" id="ExRate" autocomplete="off" dir="auto" class="form-control form-control-sm" readonly />
                                    </div>
                                </div>
                            </fieldset>
                            <fieldset>

                                <legend>
                                    <span class="avatar avatar-xl">
                                        <span class="avatar-name rounded-circle bg-soft-danger text-dark">
                                            <span class="fs-0 text-danger">Inv</span>

                                        </span>
                                    </span>
                                    <span class="text-linkedin">SL002</span>
                                </legend>
                                <div class="row p-2">
                                    <div class="col-md-12">
                                        <label for="ProductID"> @Resource.Product</label><br />
                                        <select id="ProductID" name="ProductID" class="select_2 form-control form-control-sm" onchange="GetProductUnit()">
                                        </select>
                                        <div class="d-none">
                                            <label for="UnitID"> @Resource.Unit</label><br />
                                            <select id="UnitID" name="UnitID" class="select_2 form-control form-control-sm">
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row p-2">
                                    <div class="col-md-12">
                                        <label for="Quantity"> @Resource.Quantity</label><br />
                                        <input type="text" name="Quantity" id="Quantity" autocomplete="off" dir="auto" class="form-control form-control-sm" value="1" />
                                    </div>
                                </div>

                                <div class="row p-2">
                                    <div class="col-md-6">
                                        <label for="Discount_Type"> @Resource.Discount_Type</label><br />
                                        <select id="Discount_Type" name="Discount_Type" class="select_2 form-control form-control-sm">
                                            <option value="None">@Resource.None</option>
                                            <option value="Product_Discount">@Resource.Product_Discount</option>
                                            <option value="Cash_Discount">@Resource.Cash_Discount</option>
                                        </select>
                                    </div>

                                    <div class="col-md-6">
                                        <label for="DiscountQuantity"> @Resource.DiscountQuantity</label><br />
                                        <input type="text" name="DiscountQuantity" id="DiscountQuantity" value="0" autocomplete="off" dir="auto" class="form-control form-control-sm" />
                                    </div>
                                </div>

                                <div class="row p-2">
                                    <div class="col-md-6">
                                        <label for="UnitPrice"> @Resource.UnitPrice</label><br />
                                        <input type="text" name="UnitPrice" id="UnitPrice" autocomplete="off" dir="auto" class="form-control form-control-sm" />
                                    </div>
                                    <div class="col-md-6">
                                        <label for="Add">&nbsp;</label><br />
                                        <button type="button" id="AddRow" class="btn btn-sm btn-outline-google-plus" style="width:100%">
                                            <span class="fas fa-plus" data-fa-transform="shrink-3 down-2"></span>
                                            @Resource.Add
                                        </button>
                                    </div>
                                </div>
                            </fieldset>
                        </div>
                        <div class="col-md-8">
                            <fieldset>
                                <legend>@Resource.Product_List</legend>
                                <div class="row">
                                    <div class="table-responsive Scroll" style="height:502px">
                                        <table class="table table-sm table-bordered table-striped table-hover table-responsive-lg">
                                            <thead>
                                                <tr class="table-primary">
                                                    <th>@Resource.Product</th>
                                                    <th>@Resource.Quantity</th>
                                                    <th>@Resource.Unit</th>
                                                    <th>@Resource.UnitPrice</th>
                                                    <th>@Resource.Discount_Type</th>
                                                    <th>@Resource.DiscountQuantity</th>
                                                    <th>@Resource.TotalPrice</th>

                                                    <th width="3%">Action</th>


                                                </tr>

                                            </thead>
                                            <tbody id="tblProductList">
                                            </tbody>
                                            <tfoot id="tblTotal">
                                                <tr>
                                                    <td colspan="6"><b> @Resource.TotalPrice</b></td>
                                                    <td colspan="2">
                                                        <input type="text" name="TotalPrice" id="TotalPrice" autocomplete="off" dir="auto" class="form-control form-control-sm" placeholder="0.00" readonly />
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td colspan="6"><b> @Resource.Paid_Amount</b></td>
                                                    <td colspan="2">
                                                        <input type="text" name="PaidAmount" id="PaidAmount" autocomplete="off" dir="auto" class="form-control form-control-sm" placeholder="0.00" onchange="DueBalance()" />
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td colspan="6"><b> @Resource.Due_Amount</b></td>
                                                    <td colspan="2">
                                                        <input type="text" name="DueAmount" id="DueAmount" autocomplete="off" dir="auto" class="form-control form-control-sm" placeholder="0.00" readonly />
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td colspan="6"><b> Previouse Balance</b></td>
                                                    <td colspan="2">
                                                        <input type="text" name="PreviouseBalance" id="PreviouseBalance" autocomplete="off" dir="auto" class="form-control form-control-sm" placeholder="0.00" readonly />
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td colspan="9" height="5%">
                                                        <hr />
                                                        <button type="button" style="width:100%" id="Save" class="btn btn-sm btn-outline-primary">
                                                            <span class="fas fa-plus" data-fa-transform="shrink-3 down-2"></span>

                                                            <b> @Resource.Save</b>
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                            </fieldset>

                        </div>
                    </div>
                    <div>
                        <input type="hidden" name="Tran_data" id="Tran_data" class="form-control form-control-sm" />
                        <input type="hidden" name="PurchaseID" id="PurchaseID" class="form-control form-control-sm" />
                    </div>
                </form>

            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-sm btn-outline-danger" data-bs-dismiss="modal">@Resource.Close</button>
            </div>
        </div>
    </div>
</div>
<div id="ModelSaleDetail" class="modal fade" data-keyboard="false" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">@Resource.Purchase Detail</h5>
                <button type="button" class="btn-close btn btn-sm btn-circle transition-base p-0" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row p-0">
                    <div class="col-md-12">
                        <div id="GrdSaleDetail">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-sm btn-outline-danger" data-bs-dismiss="modal">@Resource.Close</button>
            </div>
        </div>
    </div>
</div>
<div id="MenuW">
    <ul dir="rtl">
        <li>
            <img src="~/images/pencil.png" />
            <span>Detail</span>
        </li>
    </ul>
</div>
<div id="MenuR">
    <ul dir="rtl">
        <li>
            <img src="~/images/pencil.png" />
            <span>Detail</span>
        </li>
    </ul>
</div>
<script>

    function DueBalance() {
        const TotalPrice = Number($("#TotalPrice").val());
        const PaidAmount = Number($("#PaidAmount").val());
        if (PaidAmount > TotalPrice) {
            $("#PaidAmount").val('');
            toastr["error"]('Paid amount could not be grather than total price!');
        }
        else
            $("#DueAmount").val(TotalPrice - PaidAmount)
    }
    function fillExchangeRate() {
        var DealerID = $("#DealerID").val();
        var Dealer = $('#DealerID :selected').text();
        if (!Dealer.includes('AFN')) {
            $("#ExRate").val(0);
            varURL = '/INV/ExchangeRate/findExRate?DealerID=' + DealerID;
            $.ajax({
                url: varURL,
                type: "get",
                success: function (result) {
                    $("#ExRate").val(result[0].ExRate);
                    DealerCurrencyID = result[0].CurrencyID;
                    $("#UnitPrice").val('');

                }
            });
        }
    }
    function GetProductUnit() {
        var ProductID = $("#ProductID").val();
        $("#UnitID").empty();
        FillSelect2NoMsg('/INV/z_Product/ProductUnit?ProductID=' + ProductID, 'UnitID', 'UnitID', 'UnitName');

        varURL = '/INV/z_Product/findProductByID?ProductID=' + ProductID;
        $.ajax({
            url: varURL,
            type: "get",
            success: function (result) {
                var exRate = Number($("#ExRate").val());
                if (DealerCurrencyID == 1)
                    $("#UnitPrice").val(result.DefualtSalePrice);
                if (DealerCurrencyID == 2)
                    $("#UnitPrice").val(result.DefualtSalePrice / exRate);
                if (DealerCurrencyID == 3)
                    $("#UnitPrice").val((result.DefualtSalePrice * 1000) / exRate);

            }
        });

    }
    function MakeTabActive(n) {
        for (var i = 1; i < 3; i++)
            if (i == n)
                $("#tab" + i).removeClass("d-none");
            else
                $("#tab" + i).addClass("d-none");
    }

    function setgrid(n) {

        var Gridid = "";
        var GridURL = "";
        if (n == 1) {
            Gridid = "GrdWholesale";
            GridURL = '/INV/Sale/GetSales?CustomerType=1'
        }
        else if (n == 2) {
            Gridid = "GrdRetail";
            GridURL = '/INV/Sale/GetSales?CustomerType=3'
        }
        makeContextMenu("MenuW", "GrdWholesale", 200, 100);
        makeContextMenu("MenuR", "GrdRetail", 200, 100);

        const isRTL = JSON.parse(localStorage.getItem('isRTL'))
        const aln = (isRTL) ? 'right' : 'left';
        var is_adaptive = ($(document).width() <= 500) ? true : false;
        $("#" + Gridid).jqxGrid(
            {
                width: '99%',

                enabletooltips: true,
                pageable: true,
                pagermode: 'simple',
                showfilterrow: true,
                filterable: true,
                editable: false,
                autoheight: true,
                columnsresize: false,
                sortable: true,
                pagesize: 15,
                altrows: true,
                rtl: isRTL,
                adaptive: is_adaptive,
                enablebrowserselection: true,
                selectionMode: 'singlecell',
                columns: [

                    { text: 'InvoiceNo', dataField: 'InvoiceNo', width: '10%', cellsalign: aln, align: aln },
                    { text: 'ID', dataField: 'SaleID', width: '10%', cellsalign: aln, align: aln },
                    { text: 'Vendor Name', dataField: 'DelearName', cellsalign: aln, align: aln },
                    { text: 'Date', dataField: 'D_EDate', width: '10%', cellsalign: aln, align: aln },
                    { text: 'TotalPrice', dataField: 'TotalPrice', width: '10%', cellsalign: aln, align: aln },
                    { text: 'PaidAmount', dataField: 'PaidAmount', width: '10%', cellsalign: aln, align: aln },
                    { text: 'DueAmount', dataField: 'DueAmount', width: '10%', cellsalign: aln, align: aln },
                    { text: 'ExchangeRate', dataField: 'ExchangeRate', width: '10%', cellsalign: aln, align: aln },

                ]
            });

        fillgrid(GridURL, Gridid);
    }
    function fillgrid(varurl, Gridid) {
        var datafields = [
            { name: 'SaleID' },
            { name: 'InvoiceNo' },
            { name: 'D_EDate' },
            { name: 'TotalPrice' },
            { name: 'PaidAmount' },
            { name: 'DueAmount' },
            { name: 'DealerID' },
            { name: 'Remarks' },
            { name: 'CreatedOn' },
            { name: 'IsReconciled' },
            { name: 'ExchangeRate' },
            { name: 'DelearName', type: 'text' },
            { name: 'EDate', type: 'date', format: "yyyy-mm-DD" },
        ];
        var source =
        {
            datatype: "json",
            datafields: datafields,
            cache: false,
            url: varurl,
            root: 'Rows'
        };
        var dataadapter = new $.jqx.dataAdapter(source, {
            loadError: function (xhr, status, error) {

            }
        }
        );

        $("#" + Gridid).jqxGrid(
            {
                source: dataadapter
            });

    }

    function setDetailgrid() {

        const isRTL = JSON.parse(localStorage.getItem('isRTL'))
        const aln = (isRTL) ? 'right' : 'left';
        var isAdaptive = ($(document).width() <= 500) ? true : false;

        $("#GrdSaleDetail").jqxGrid(
            {
                width: '99%',
                // enabletooltips: true,
                pageable: true,
                pagermode: 'simple',
                showfilterrow: true,
                filterable: true,
                editable: false,
                autoheight: true,
                columnsresize: false,
                sortable: true,
                pagesize: 15,
                altrows: true,
                rtl: isRTL,
                adaptive: isAdaptive,
                columns: [

                    { text: 'ID', dataField: 'SlDetailID', width: '10%', cellsalign: aln, align: aln },
                    { text: 'Product', dataField: 'PName', cellsalign: aln, align: aln },
                    { text: 'Quantity', dataField: 'Quantity', width: '10%', cellsalign: aln, align: aln },
                    { text: 'Unit Price', dataField: 'UnitPrice', width: '10%', cellsalign: aln, align: aln },
                    { text: 'Discount_Type', dataField: 'Discount_Type', width: '10%', cellsalign: aln, align: aln },
                    { text: 'DiscountQuantity', dataField: 'DiscountQuantity', width: '10%', cellsalign: aln, align: aln },
                    { text: 'Total Price', dataField: 'TotalPrice', width: '10%', cellsalign: aln, align: aln },

                ]

            });
    }

    function fillDetailgrid(varurl) {

        var datafields = [
            { name: 'SlDetailID' },
            { name: 'ProductID' },
            { name: 'PName', type: 'text' },
            { name: 'Quantity' },
            { name: 'UnitPrice' },
            { name: 'TotalPrice' },
            { name: 'Discount_Type' },
            { name: 'DiscountQuantity' },
            { name: 'SaleID' },

        ];
        var source =
        {
            datatype: "json",
            datafields: datafields,
            cache: false,
            url: varurl,
            root: 'Rows'
        };

        var dataadapter = new $.jqx.dataAdapter(source, {
            loadError: function (xhr, status, error) {
                console.log(error);
            }
        }
        );

        $("#GrdSaleDetail").jqxGrid(
            {
                source: dataadapter
            });
    }
</script>
